name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_ENV: test
  PORT: 3333
  HOST: localhost
  LOG_LEVEL: error
  APP_KEY: test-ci-app-key-that-is-at-least-16-chars
  SESSION_DRIVER: memory
  DB_HOST: localhost
  DB_PORT: 5432
  DB_USER: postgres
  DB_PASSWORD: postgres
  DB_DATABASE: fitness-platform-adonis-test
  APP_NAME: fitness_platform
  APP_VERSION: 0.0.1
  APP_ENV: development
  QUEUE_DRIVER: database
  FITBIT_CLIENT_ID: ci-test-client-id
  FITBIT_CLIENT_SECRET: ci-test-client-secret
  FITBIT_CALLBACK_URL: http://localhost:3333/auth/fitbit/callback
  FITBIT_SUBSCRIBER_VERIFICATION_CODE: ci-test-verification-code

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - run: pnpm lint
        working-directory: packages/platform

  typecheck:
    name: Typecheck
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - run: pnpm typecheck
        working-directory: packages/platform

  test:
    name: Test
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: fitness-platform-adonis-test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - run: pnpm test
        working-directory: packages/platform
